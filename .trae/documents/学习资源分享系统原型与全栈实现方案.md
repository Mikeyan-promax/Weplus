## 项目目标
- 为“学习资源”板块提供面向学生的下载/预览/评分/评论功能，以及面向管理员的上传与资源管理。
- 设计简洁现代的UI，蓝/绿友好配色，响应式布局。
- 与当前 PostgreSQL 数据库完美适配，修复数据库变更后导致的报错与不可用问题。

## 现状调研（基于现有代码）
- 后端：`backend/app/api/study_resources_api.py` 已包含资源分页、管理员列表、上传、评分等端点骨架；模型位于 `backend/database/study_resources_models.py` 与 `backend/app/models/study_resources.py`；数据库 Schema 在 `backend/database/study_resources_schema.sql`（含分类、资源、评分、评论、下载记录等表）。
- 前端：
  - 学生侧：`frontend2/src/components/StudyResources.tsx`（分类、列表、搜索、下载）、`ResourcePreview.tsx`（预览）、`RatingStats.tsx`、`StarRating.tsx`、`CommentList.tsx`、`CommentForm.tsx`。
  - 管理端：`frontend2/src/components/admin/StudyResourcesManagement.tsx`（管理员资源列表与操作）。
- 代理：`frontend2/vite.config.ts` 已将 `/api` 代理到后端（本地 8000）。
- 问题：路由别名不完全统一（如前端调用 `/api/study-resources/resources`，后端当前分页端点为 `/api/study-resources/`）；数据库更换后部分字段/索引不匹配，导致功能异常。

## 数据库设计与适配
- 表（与现有 Schema 对齐并补充）：
  - `resource_categories`：分类（代码、名称、描述、图标、颜色、排序）。
  - `study_resources`：资源（标题、描述、文件路径/类型/大小、分类、下载/查看计数、评分统计、状态、上传时间、标签/关键词、元数据）。
  - `resource_ratings`：评分（资源ID、用户ID、评分1-5、时间）。
  - `resource_comments`：评论（资源ID、用户ID、内容、父评论、状态/置顶、时间）。
  - `resource_downloads`：下载记录（资源ID、用户ID或匿名、IP、UA、时间）。
- 适配动作：
  - 校验/迁移列名与类型（如 `rating_avg`/`rating_count`、`file_size`、`upload_time`、`tags`/`keywords` JSON/文本）；
  - 创建缺失索引（`resource_*` 表上的常用查询字段）；
  - 初始化分类数据（含：英语四六级(cet)、雅思(ielts)、考研(postgrad)、专业课程(professional)、软件技能(software)、学术写作(academic)）。

## 后端接口设计
- 公共端点（学生）：
  - `GET /api/study-resources/categories`：返回分类列表（含图标/颜色/排序）。
  - `GET /api/study-resources/resources`（别名，映射到现有分页逻辑）：分页列表，支持 `category_id`、`difficulty_level`、`resource_type`、`query`（搜索）、`page/page_size`、`sort_by/sort_order`。
  - `GET /api/study-resources/{id}`：资源详情（名称、大小、上传时间、评分统计）。
  - `GET /api/study-resources/{id}/download`：下载文件（记录下载日志，递增计数）。
  - `GET /api/study-resources/{id}/ratings`：评分统计与明细。
  - `POST /api/study-resources/{id}/rate`：提交评分（登录或匿名策略按现状实现，默认支持用户ID为可选）。
  - `GET /api/study-resources/{id}/comments`：评论列表（分页/楼中楼）。
  - `POST /api/study-resources/{id}/comments`：新增评论（含父评论）。
- 管理端（需管理员Token）：
  - `GET /api/study-resources/admin/resources`：管理员资源列表（分页/筛选）。
  - `POST /api/study-resources/admin/upload`：上传文件（含标题/描述/分类/难度/标签/关键词/作者/来源URL），存储至服务端目录，写资源记录；后台任务处理缩略图/文本提取（如有）。
  - `PUT /api/study-resources/admin/resources/{id}`：更新元数据（分类、标签、描述、状态）。
  - `DELETE /api/study-resources/admin/resources/{id}`：删除资源（软删/真删可配置）。
- 路由兼容：补充 `GET /api/study-resources/resources` 别名以适配前端已写死路径；确保 `admin` 前缀端点与现组件一致。

## 文件存储与下载
- 存储目录优先级：环境变量 `UPLOAD_DIR_STUDY_RESOURCES` → Settings → 默认 `uploads/study_resources`（日志已有显示）。
- 允许文件类型与大小限制：在后端常量或配置中定义（如 `pdf/docx/pptx/xlsx/zip`），拒绝可执行/危险类型。
- 下载实现：返回 `FileResponse` 并记录下载日志（`resource_downloads`），增加 `download_count`；支持断点续传与正确的 `Content-Disposition`。
- 预览：
  - PDF/图片：支持内嵌预览（`ResourcePreview.tsx` 现有组件基础）。
  - Office 文档：优先下载，后续可接入在线预览服务（选做）。

## 前端原型与交互
- 学生侧页面（`StudyResources.tsx`）：
  - 顶部区：蓝/绿友好配色，标题与简介，搜索栏（关键词）。
  - 分类导航：六大板块（cet/ielts/postgrad/professional/software/academic），便捷切换；移动端横向滚动。
  - 列表：资源卡/表格（名称、大小、上传时间、标签、评分），下载按钮；支持分页。
  - 预览：点击触发模态框预览（可关闭）。
  - 评分/评论：详情页 `ResourceDetail.tsx` 中展示评分统计与评论列表；支持评分提交/评论提交。
- 响应式与风格：
  - 使用现有 CSS 架构（*.css 组件样式），移动端优先体验，清晰的视觉层次；蓝（#4A90E2）/绿（#50E3C2）为主。

## 管理后台功能
- `StudyResourcesManagement.tsx` 根据 `admin_token` 调用 `/api/study-resources/admin/resources` 与 `/admin/upload`。
- 支持上传文件、编辑元数据、状态管理、分类/标签调整、删除；列表展示统计与分页。

## 认证与权限
- 学生端：公共读取无需登录；评分/评论可选登录（根据现有用户系统接入，默认允许匿名并标识）。
- 管理端：使用现有管理员 JWT（`Authorization: Bearer admin_token`），后端 `verify_admin_token` 已实现；CORS 与 IP 白名单与现配置一致。

## 安全与合规
- 文件类型白名单、大小上限、存储路径隔离；拒绝脚本与可执行类型。
- 下载接口不暴露真实路径；使用安全文件名与 `Content-Disposition`。
- 不在代码中存储任何密钥；令牌仅用于认证头部。

## 迁移与修复清单
- 同步/修复数据库结构：执行/比对 `study_resources_schema.sql` 与现库，确保列索引齐全。
- 路由别名补齐：后端增加 `GET /api/study-resources/resources` 适配前端；自测前端已写死路径的调用。
- 修复前端类型问题（已开始）：清理 `any` 与未用变量，维持零错误目标；统一中文函数级注释。
- 文件存储参数统一：读取环境变量与 Settings，后端日志已显示目录为 `uploads/study_resources`。

## 验证与测试
- 后端单元/集成：
  - 列表/搜索/下载/评分/评论/上传覆盖测试；
  - 管理端认证与上传流程；
- 前端手动测试：
  - 分类导航、搜索、分页、预览、评分/评论、下载按钮；
  - 管理端上传与编辑；
- 开发态预览：`npm run dev`（5173），`uvicorn main:app --reload --port 8000`；Vite 代理 `/api`。

## 推送与部署
- 按你的既定 Git 流程：拉取→提交→推送；必要时使用 `--force-with-lease`。
- Railway/生产：沿用当前后端部署方式；邮件服务与云端SMTP留作后续优化。

## 代码实现约定
- 全部注释与文案使用中文；为每个函数添加“函数级注释”。
- 严格遵循现有项目的代码风格与模块结构；优先复用现有组件与服务。

## 需要你的确认
- 是否按上述方案实施，包括：
  1) 补齐/统一后端端点（含 `/resources` 别名与评论端点实现），
  2) 校验/迁移数据库结构（不破坏现有数据），
  3) 完成前端页面交互与类型清理，
  4) 管理后台上传与资源管理联调。