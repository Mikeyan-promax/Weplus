; supervisord 配置：同容器内启动后端 Uvicorn 与 Nginx
[supervisord]
nodaemon=true
logfile=/var/log/supervisord.log
pidfile=/var/run/supervisord.pid

[program:backend]
directory=/app
command=/usr/local/bin/uvicorn main:app --host 0.0.0.0 --port 8000
autostart=true
autorestart=true
stdout_logfile=/dev/stdout
stderr_logfile=/dev/stderr
stdout_logfile_maxbytes=0
stderr_logfile_maxbytes=0
environment=PORT=%(ENV_PORT)s
priority=10

[program:nginx]
command=/bin/sh -c "set -e; export PORT=\"${PORT:-80}\"; echo \"[startup] ENV PORT=$PORT\"; echo \"[startup] Rendering /etc/nginx/nginx.conf from template\"; envsubst '\$PORT' < /etc/nginx/nginx.conf.template > /etc/nginx/nginx.conf; echo \"[startup] Rendered nginx.conf (first 200 lines):\"; sed -n '1,200p' /etc/nginx/nginx.conf; echo \"[startup] Validating nginx configuration\"; /usr/sbin/nginx -t || (echo \"[error] nginx -t failed\"; sed -n '1,200p' /etc/nginx/nginx.conf; exit 1); echo \"[startup] Nginx will listen on PORT=$PORT\"; /usr/sbin/nginx -g 'daemon off;'"
autostart=true
autorestart=true
stdout_logfile=/dev/stdout
stderr_logfile=/dev/stderr
stdout_logfile_maxbytes=0
stderr_logfile_maxbytes=0
environment=PORT=%(ENV_PORT)s
priority=20
